---

### **Android开发人员技术文档**

---

#### **1. 后端服务基础信息**
- **服务地址**  
  - 开发环境：`http://<服务器IP>:5000`  
  - 生产环境：`https://<生产域名>`（启用国密SSL/TLS）
- **通信协议**  
  - 所有接口均使用 **HTTPS**（生产环境强制国密SSL）。
  - 数据格式：`application/json`。
- **认证方式**  
  - 使用 **SM2加密的JWT令牌**，通过 `Authorization` 请求头传递（格式：`Bearer <加密后的Token>`）。

---

#### **2. 关键集成点**
##### **2.1 国密算法要求**
- **SM2密钥对生成**  
  - 客户端需生成SM2密钥对（使用`GMSSL`库或硬件模块）。
  - 公钥格式：以 `04` 开头的非压缩HEX字符串（130字节）。
- **数据加密层级**  
  - **传输层**：Token使用SM2加密。
  - **业务层**：敏感字段（如事件详情）使用SM4加密。

##### **2.2 Token管理**
- **获取流程**  
  1. 客户端生成SM2密钥对，注册时提交公钥。
  2. 登录接口返回SM2加密的JWT Token。
  3. 后续请求需在Header中携带加密后的Token。
- **自动刷新**  
  - 调用 `/refresh-token` 接口刷新Token（需携带当前Token）。

---

#### **3. 安全规范**
- **敏感数据存储**  
  - 用户私钥必须通过Android Keystore保护，禁止明文存储。
- **请求签名**  
  - 关键业务请求（如事件提交）需用SM2私钥签名请求体，字段包括：`timestamp` + `请求数据`。
- **防重放攻击**  
  - 所有请求需包含 `timestamp` 字段（Unix时间戳），服务端校验时间误差（±5分钟）。

---

#### **4. 数据库模型摘要**
| 表名             | Android端需关注字段                                   |
|------------------|------------------------------------------------------|
| `users`          | `user_id`, `role_level`（权限等级：1=管理员，0=普通） |
| `incidents`      | `incident_level`（1-紧急，2-高危，3-一般）            |
| `emergency_plans`| `version`（版本号格式：vX.Y.Z）                      |

---

#### **5. 联调注意事项**
1. **测试密钥生成**  
   ```bash
   # 使用OpenSSL生成测试密钥对
   openssl ecparam -genkey -name sm2p256v1 -out sm2.key
   openssl ec -in sm2.key -pubout -out sm2.pub
   ```
2. **调试模式**  
   - 开发环境可临时关闭HTTPS，但需确保SM2加密流程完整。
3. **日志追踪**  
   - 请求失败时检查响应头 `X-Request-Id`，用于后端定位问题。

---
